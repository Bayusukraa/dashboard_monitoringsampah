<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi Smart Trash Monitoring</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:'Inter','Segoe UI',system-ui,sans-serif;
    background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);
    min-height:100vh;
    padding:16px;
  }
  .container{max-width:1600px;margin:auto}

  /* Header */
  .header-bar{
    background:linear-gradient(135deg,#1b5e20 0%,#2e7d32 100%);
    padding:24px 20px;
    border-radius:20px;
    box-shadow:0 10px 40px rgba(27,94,32,.25);
    margin-bottom:24px;
    position:relative;
    overflow:hidden;
    text-align:center;
    color:white;
  }
  .header-bar::before{
    content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;
    background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);
    animation:pulse 15s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{transform:scale(1);opacity:.5}50%{transform:scale(1.1);opacity:.3}}
  h1{
    font-size:2.4rem;
    font-weight:700;
    margin-bottom:12px;
    text-shadow:0 4px 12px rgba(0,0,0,.2);
    letter-spacing:-0.5px;
  }
  .connection-status{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 24px;border-radius:24px;
    font-weight:600;font-size:.95em;
    color:white;
    margin-top:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.15);
  }
  .connection-status::before{
    content:'';width:10px;height:10px;border-radius:50%;animation:blink 2s infinite;
  }
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  .status-disconnected{background:#d32f2f}.status-disconnected::before{background:#ffcdd2}
  .status-connecting{background:#f57c00}.status-connecting::before{background:#ffe0b2}
  .status-connected{background:#388e3c}.status-connected::before{background:#c8e6c9}

  .close-btn{
    position:fixed;
    bottom:24px;left:24px;
    background:white;
    border:none;color:#64748b;
    width:56px;height:56px;
    border-radius:50%;
    font-size:1.4em;
    cursor:pointer;
    transition:all .3s;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 8px 24px rgba(0,0,0,.15);
    z-index:1000;
  }
  .close-btn:hover{
    background:#f1f5f9;color:#334155;
    transform:translateY(-4px) rotate(90deg);
    box-shadow:0 12px 32px rgba(0,0,0,.2);
  }

  .stats-overview{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:16px;
    margin-bottom:28px;
  }
  .stat-card{
    background:white;
    border-radius:16px;
    padding:24px;
    box-shadow:0 4px 20px rgba(0,0,0,.08);
    text-align:center;
    transition:all .3s;
    border:2px solid transparent;
  }
  .stat-card:hover{
    transform:translateY(-4px);
    box-shadow:0 12px 32px rgba(0,0,0,.15);
    border-color:#2e7d32;
  }
  .stat-icon{font-size:2.2em;margin-bottom:12px;display:block}
  .stat-value{font-size:2.8em;font-weight:800;color:#1b5e20;line-height:1;margin-bottom:8px}
  .stat-label{font-size:.95em;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.5px}

  .tab-nav{
    display:flex;
    gap:8px;
    margin:24px 0;
    background:white;
    border-radius:16px;
    padding:8px;
    box-shadow:0 4px 20px rgba(0,0,0,.08);
    flex-wrap:wrap;
  }
  .tab-btn{
    flex:1;
    min-width:140px;
    padding:12px 16px;
    border-radius:12px;
    font-weight:600;
    cursor:pointer;
    transition:all .3s;
    background:transparent;
    color:#64748b;
    border:none;
  }
  .tab-btn.active{
    background:#2e7d32;
    color:white;
  }

  .control-panel{
    background:white;
    border-radius:20px;
    padding:24px;
    box-shadow:0 8px 32px rgba(0,0,0,.1);
    margin-bottom:28px;
  }
  .control-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:20px;
  }
  .control-card{
    background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);
    border-radius:16px;
    padding:24px;
    border:2px solid #e2e8f0;
    transition:all .3s;
  }
  .control-card:hover{
    border-color:#2e7d32;
    box-shadow:0 4px 16px rgba(0,0,0,.08);
  }
  .control-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .control-icon{font-size:1.8em}
  .control-title{font-size:1.1em;font-weight:700;color:#1e293b}
  .control-subtitle{font-size:.85em;color:#64748b;margin-bottom:16px}
  .toggle-container{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .toggle-label{font-weight:600;color:#475569;font-size:.95em}
  .toggle-switch{position:relative;width:60px;height:32px;cursor:pointer}
  .toggle-switch input{display:none}
  .toggle-slider{
    position:absolute;top:0;left:0;right:0;bottom:0;
    background:#cbd5e1;border-radius:32px;transition:all .3s;
  }
  .toggle-slider:before{
    content:'';position:absolute;height:24px;width:24px;
    left:4px;bottom:4px;background:white;border-radius:50%;
    transition:all .3s;box-shadow:0 2px 4px rgba(0,0,0,.2);
  }
  .toggle-switch input:checked+.toggle-slider{background:#4caf50}
  .toggle-switch input:checked+.toggle-slider:before{transform:translateX(28px)}
  .device-mode-badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 16px;border-radius:20px;
    font-size:.85em;font-weight:700;margin-top:12px;
  }
  .mode-active{background:#e8f5e9;color:#2e7d32}
  .mode-sleep{background:#fff3e0;color:#f57c00}
  .mode-manual-off{background:#ffebee;color:#c62828}

  .main-content{
    display:grid;
    grid-template-columns:1fr;
    gap:24px;
    margin-bottom:32px;
  }
  .map-container, .devices-list{
    background:white;
    border-radius:20px;
    padding:24px;
    box-shadow:0 8px 32px rgba(0,0,0,.1);
  }
  .section-title{
    font-size:1.4em;
    font-weight:700;
    color:#1b5e20;
    margin-bottom:20px;
    display:flex;
    align-items:center;
    gap:12px;
  }
  .section-title::before{
    content:'';width:4px;height:28px;
    background:linear-gradient(180deg,#2e7d32,#66bb6a);
    border-radius:2px;
  }
  #map{
    height:450px;
    border-radius:16px;
    box-shadow:0 4px 16px rgba(0,0,0,.1);
  }
  .devices-scroll{
    max-height:500px;
    overflow-y:auto;
    padding-right:8px;
  }
  .devices-scroll::-webkit-scrollbar{width:6px}
  .devices-scroll::-webkit-scrollbar-track{background:#f1f5f9;border-radius:3px}
  .devices-scroll::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:3px}

  .device-card{
    background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);
    border-radius:16px;
    padding:20px;
    margin-bottom:16px;
    border-left:6px solid;
    box-shadow:0 4px 16px rgba(0,0,0,.06);
    transition:all .3s;
  }
  .device-card:hover{transform:translateX(4px);box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .device-kosong{border-color:#4caf50}
  .device-hampir{border-color:#ff9800}
  .device-penuh{border-color:#f44336}
  .device-offline{border-color:#9e9e9e}
  .device-sleep{border-color:#ffa726}
  .device-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .device-name{font-weight:700;font-size:1.15em;color:#1e293b}
  .device-status-badge{
    padding:6px 16px;border-radius:20px;
    font-size:.8em;font-weight:700;
    color:white;text-transform:uppercase;
    letter-spacing:.5px;box-shadow:0 2px 8px rgba(0,0,0,.15);
  }
  .badge-kosong{background:linear-gradient(135deg,#4caf50,#66bb6a)}
  .badge-hampir{background:linear-gradient(135deg,#ff9800,#ffa726)}
  .badge-penuh{background:linear-gradient(135deg,#f44336,#e57373)}
  .badge-offline{background:linear-gradient(135deg,#9e9e9e,#bdbdbd)}
  .badge-sleep{background:linear-gradient(135deg,#ffa726,#ffb74d)}
  .progress-mini{
    width:100%;height:10px;
    background:#e0e0e0;border-radius:6px;
    overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);
  }
  .progress-fill{height:100%;transition:width .5s ease}

  /* === HISTORY PANEL - DIPERBAIKI UNTUK MOBILE === */
  .history-panel{
    background:white;
    border-radius:20px;
    padding:24px;
    box-shadow:0 8px 32px rgba(0,0,0,.1);
  }
  .history-controls{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    margin-bottom:24px;
    align-items:end;
  }
  .filter-group{
    display:flex;
    flex-direction:column;
    gap:6px;
    flex:1;
    min-width:180px;
  }
  .filter-label{font-weight:600;color:#475569;font-size:0.95em}
  .filter-input, .filter-select{
    padding:10px 14px;
    border:1px solid #cbd5e1;
    border-radius:8px;
    background:#f8f9fa;
    transition:all .3s;
    font-size:0.95em;
  }
  .filter-input:focus, .filter-select:focus{
    outline:none;border-color:#2e7d32;
    box-shadow:0 0 0 3px rgba(46,125,50,.1);
  }
  .btn-action{
    padding:12px 20px;
    border:none;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
    transition:all .3s;
    color:white;
    align-self:end;
  }
  .btn-export{background:#4caf50}
  .btn-export:hover{background:#388e3c;transform:translateY(-2px)}
  .btn-clear{background:#f44336}
  .btn-clear:hover{background:#d32f2f;transform:translateY(-2px)}

  /* Wrapper untuk tabel responsif */
  .table-wrapper {
    overflow-x:auto;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    margin-top:16px;
  }
  .history-table{
    width:100%;
    min-width:700px; /* Minimal lebar agar tetap readable saat di-scroll */
    border-collapse:collapse;
    font-size:0.95em;
  }
  .history-table th{
    background:#f1f5f9;
    color:#1e293b;
    padding:14px 12px;
    text-align:left;
    font-weight:700;
    position:sticky;
    top:0;
    z-index:1;
  }
  .history-table td{
    padding:12px;
    border-bottom:1px solid #e2e8f0;
    white-space:nowrap;
  }
  .history-table tr:hover{background:#f8fafc}
  .history-row-kosong{color:#2e7d32;font-weight:600}
  .history-row-hampir{color:#f57c00;font-weight:600}
  .history-row-penuh{color:#d32f2f;font-weight:700}

  .no-data{
    text-align:center;
    color:#64748b;
    padding:40px;
    font-size:1.1em;
  }

  .timestamp{
    text-align:center;
    color:#475569;
    margin-top:24px;
    padding:16px;
    background:white;
    border-radius:12px;
    font-weight:600;
    box-shadow:0 4px 16px rgba(0,0,0,.05);
  }

  /* RESPONSIVE */
  @media (min-width: 640px) {
    body { padding:20px; }
    h1 { font-size:2.6rem; }
    .header-bar { padding:28px 32px; }
  }

  @media (min-width: 768px) {
    .stats-overview { gap:20px; }
    .main-content { grid-template-columns:1.2fr 1fr; }
    #map { height:550px; }
    .history-controls { align-items:center; }
    .filter-group { flex-direction:row; align-items:center; }
  }

  @media (min-width: 1024px) {
    body { padding:24px; }
    h1 { font-size:2.8rem; }
    .stat-value { font-size:3em; }
  }

  @media (max-width: 480px) {
    .close-btn {
      width:48px;height:48px;
      bottom:16px;left:16px;
      font-size:1.2em;
    }
    h1 { font-size:1.9rem; }
    .tab-btn { min-width:110px; font-size:0.9em; padding:10px 12px; }
    .stat-card { padding:18px; }
    .stat-value { font-size:2.2em; }
    .control-card { padding:18px; }
    .device-card { padding:16px; }
    .section-title { font-size:1.2em; }
    .btn-action { padding:10px 16px; font-size:0.9em; }
    .filter-label { font-size:0.9em; }
    .filter-input, .filter-select { font-size:0.9em; }
    .history-table { font-size:0.85em; }
    .history-table th, .history-table td { padding:10px 8px; }
  }
</style>
</head>
<body>
<div class="container">
  <header class="header-bar">
    <button class="close-btn" onclick="window.location.href='https://dashboardsamdbal.vercel.app/'">‚úï</button>
    <div>
      <h1>üöÆ Multi Smart Trash Monitoring System</h1>
      <div id="connectionStatus" class="connection-status status-disconnected">DISCONNECTED</div>
    </div>
  </header>

  <div class="stats-overview">
    <div class="stat-card"><span class="stat-icon">üìä</span><div id="totalDevices" class="stat-value">0</div><div class="stat-label">Total Device</div></div>
    <div class="stat-card"><span class="stat-icon">‚úÖ</span><div id="kosongCount" class="stat-value">0</div><div class="stat-label">Kosong</div></div>
    <div class="stat-card"><span class="stat-icon">‚ö†Ô∏è</span><div id="hampirCount" class="stat-value">0</div><div class="stat-label">Hampir Penuh</div></div>
    <div class="stat-card"><span class="stat-icon">üî¥</span><div id="penuhCount" class="stat-value">0</div><div class="stat-label">Penuh</div></div>
    <div class="stat-card"><span class="stat-icon">üì°</span><div id="offlineCount" class="stat-value">0</div><div class="stat-label">Offline/Sleep</div></div>
  </div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="openTab('realtime')">Real-time Monitoring</button>
    <button class="tab-btn" onclick="openTab('history')">History Log (Semua Data)</button>
  </div>

  <div id="realtime" class="tab-content active">
    <div class="control-panel">
      <div class="control-grid">
        <div class="control-card">
          <div class="control-header">
            <span class="control-icon">‚è∞</span>
            <div><div class="control-title">Auto Sleep Mode</div><div class="control-subtitle">Otomatis sleep jam 12:00‚Äì18:00</div></div>
          </div>
          <div class="toggle-container">
            <span class="toggle-label">Auto Sleep</span>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleAutoSleep" checked onchange="toggleAutoSleep()">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div id="autoSleepStatus" class="device-mode-badge mode-active">üü¢ AKTIF</div>
        </div>

        <div class="control-card">
          <div class="control-header">
            <span class="control-icon">üò¥</span>
            <div><div class="control-title">Sleep Manual</div><div class="control-subtitle">Paksa sleep semua device sekarang</div></div>
          </div>
          <div class="toggle-container">
            <span class="toggle-label">Sleep Sekarang</span>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleManualSleep" onchange="toggleManualSleep()">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div id="manualSleepStatus" class="device-mode-badge mode-manual-off">üî¥ MATI</div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="map-container">
        <h3 class="section-title">üó∫Ô∏è Peta Lokasi Real-time</h3>
        <div id="map"></div>
      </div>
      <div class="devices-list">
        <h3 class="section-title">üìã Status Perangkat</h3>
        <div class="devices-scroll" id="devicesList"></div>
      </div>
    </div>
  </div>

  <div id="history" class="tab-content">
    <div class="history-panel">
      <h3 class="section-title">üìú Riwayat Lengkap Semua Pengukuran</h3>
      <div class="history-controls">
        <div class="filter-group">
          <label class="filter-label">Tanggal Mulai</label>
          <input type="date" id="filterStartDate" class="filter-input" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label class="filter-label">Tanggal Akhir</label>
          <input type="date" id="filterEndDate" class="filter-input" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label class="filter-label">Device</label>
          <select id="filterDevice" class="filter-select" onchange="applyFilters()">
            <option value="">Semua</option>
            <option value="Tong Parkir A">Tong Parkir A</option>
            <option value="Tong Parkir B">Tong Parkir B</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select id="filterStatus" class="filter-select" onchange="applyFilters()">
            <option value="">Semua</option>
            <option value="KOSONG">Kosong</option>
            <option value="HAMPIR PENUH">Hampir Penuh</option>
            <option value="PENUH">Penuh</option>
          </select>
        </div>
        <div style="display:flex;gap:12px;">
          <button class="btn-action btn-export" onclick="exportToCSV()">Export CSV</button>
          <button class="btn-action btn-clear" onclick="clearAllData()">Clear All Data</button>
        </div>
      </div>

      <div id="historyLoading">‚è≥ Memuat riwayat dari Firebase...</div>

      <!-- Wrapper penting untuk responsif tabel -->
      <div class="table-wrapper">
        <table class="history-table" id="historyTable" style="display:none">
          <thead>
            <tr>
              <th>Waktu</th>
              <th>Device</th>
              <th>Status</th>
              <th>Jarak (cm)</th>
              <th>Persentase</th>
              <th>Urgensi</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div id="noHistory" class="no-data" style="display:none">Belum ada riwayat pengukuran.</div>
    </div>
  </div>

  <div class="timestamp">üïê System Time: <span id="systemTime"></span></div>
</div>

<!-- Script tetap sama -->
<script>
// Script Anda yang sebelumnya (tidak ada perubahan fungsionalitas)
const firebaseConfig = {
  apiKey: "AIzaSyAD4VAIS-pFsgZXaEScz21hYvMyn9Wtgow",
  authDomain: "samdbal.firebaseapp.com",
  databaseURL: "https://samdbal-default-rtdb.firebaseio.com",
  projectId: "samdbal",
  storageBucket: "samdbal.firebasestorage.app",
  messagingSenderId: "51203793380",
  appId: "1:51203793380:web:5c28a2e75fad0fc0ffe7f1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const devices = [
  {name:"Tong Parkir A", topic:"smarttrash/device1/data", control:"smarttrash/device1/control", lat:-8.6705, lng:115.2126, id:"device1"},
  {name:"Tong Parkir B", topic:"smarttrash/device2/data", control:"smarttrash/device2/control", lat:-8.6712, lng:115.2131, id:"device2"}
];

let devicesData = {};
let autoSleepMode = true;
let manualSleep = false;
let markers = {};
let map;
let allHistoryData = [];

const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt", {keepalive:60, reconnectPeriod:3000});

function isInSleepTime() {
  const now = new Date();
  const hour = now.getHours();
  return hour >= 12 && hour < 18;
}

function toggleAutoSleep() {
  autoSleepMode = document.getElementById('toggleAutoSleep').checked;
  updateAutoSleepDisplay();
  render();
  const command = autoSleepMode ? "AUTO_SLEEP_ON" : "AUTO_SLEEP_OFF";
  devices.forEach(d => client.publish(d.control, command));
}

function toggleManualSleep() {
  manualSleep = document.getElementById('toggleManualSleep').checked;
  const status = document.getElementById('manualSleepStatus');
  if (manualSleep) {
    status.className = 'device-mode-badge mode-sleep';
    status.textContent = 'üò¥ SLEEP MANUAL AKTIF';
    devices.forEach(d => client.publish(d.control, "SLEEP"));
  } else {
    status.className = 'device-mode-badge mode-manual-off';
    status.textContent = 'üî¥ MATI';
    devices.forEach(d => client.publish(d.control, "WAKE"));
  }
  render();
}

function updateAutoSleepDisplay() {
  const badge = document.getElementById('autoSleepStatus');
  if (autoSleepMode) {
    badge.className = isInSleepTime() ? 'device-mode-badge mode-sleep' : 'device-mode-badge mode-active';
    badge.textContent = isInSleepTime() ? 'üò¥ SLEEP OTOMATIS' : 'üü¢ AKTIF';
  } else {
    badge.className = 'device-mode-badge mode-manual-off';
    badge.textContent = 'üî¥ NONAKTIF';
  }
}

map = L.map("map").setView([-8.6708, 115.2128], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {attribution: '¬© OpenStreetMap'}).addTo(map);
devices.forEach(d => {
  markers[d.topic] = L.circleMarker([d.lat, d.lng], {radius:12, fillColor:"#9e9e9e", color:"#fff", weight:3, fillOpacity:.9})
    .addTo(map)
    .bindPopup(`<strong>${d.name}</strong><br>Status: Menunggu...`);
});

function render() {
  let k=0, h=0, p=0, o=0;
  const list = document.getElementById("devicesList");
  list.innerHTML = "";
  devices.forEach(d => {
    const data = devicesData[d.topic];
    let cls = "device-offline", badge = "badge-offline", text = "OFFLINE", persen = 0;

    const isManualSleep = manualSleep;
    const isAutoSleep = autoSleepMode && isInSleepTime();

    if (isManualSleep) {
      cls = "device-sleep"; badge = "badge-sleep"; text = "SLEEP MANUAL"; o++;
    } else if (isAutoSleep) {
      cls = "device-sleep"; badge = "badge-sleep"; text = "SLEEP AUTO"; o++;
    } else if (data) {
      persen = data.persentase || 0;
      if (data.status === "KOSONG") { cls="device-kosong"; badge="badge-kosong"; text="KOSONG"; k++; }
      else if (data.status === "HAMPIR PENUH") { cls="device-hampir"; badge="badge-hampir"; text="HAMPIR PENUH"; h++; }
      else if (data.status === "PENUH") { cls="device-penuh"; badge="badge-penuh"; text="PENUH"; p++; }
    } else {
      o++;
    }

    const marker = markers[d.topic];
    if (marker) {
      const color = isManualSleep || isAutoSleep ? "#ffa726" : 
                    data && data.status === "KOSONG" ? "#4caf50" : 
                    data && data.status === "HAMPIR PENUH" ? "#ff9800" : "#f44336";
      marker.setStyle({fillColor: color || "#9e9e9e"});
      marker.setPopupContent(`<strong>${d.name}</strong><br>Status: ${text}<br>Jarak: ${data?.jarak || '-'} cm<br>Persentase: ${persen}%`);
    }

    const el = document.createElement("div");
    el.className = `device-card ${cls}`;
    el.innerHTML = `<div class="device-header"><div class="device-name">${d.name}</div><div class="device-status-badge ${badge}">${text}</div></div>
                    <div class="progress-mini"><div class="progress-fill" style="width:${persen}%;background:${persen<30?"#4caf50":persen<70?"#ff9800":"#f44336"}"></div></div>`;
    list.appendChild(el);
  });

  document.getElementById('totalDevices').textContent = devices.length;
  document.getElementById('kosongCount').textContent = k;
  document.getElementById('hampirCount').textContent = h;
  document.getElementById('penuhCount').textContent = p;
  document.getElementById('offlineCount').textContent = o;
}

client.on("connect", () => {
  document.getElementById('connectionStatus').className = "connection-status status-connected";
  document.getElementById('connectionStatus').textContent = "CONNECTED";
  client.subscribe("smarttrash/+/data");
});

client.on("message", (topic, msg) => {
  try {
    const data = JSON.parse(msg.toString());
    devicesData[topic] = data;
    render();
  } catch(e) { console.error(e); }
});

setInterval(() => {
  document.getElementById('systemTime').textContent = new Date().toLocaleString('id-ID');
  updateAutoSleepDisplay();
  render();
}, 1000);

function openTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');
  if (tabName === 'history') loadHistory();
}

function loadHistory() {
  const historyBody = document.getElementById('historyBody');
  const noHistory = document.getElementById('noHistory');
  const loading = document.getElementById('historyLoading');
  const table = document.getElementById('historyTable');
  
  historyBody.innerHTML = '';
  allHistoryData = [];
  let hasData = false;

  devices.forEach(device => {
    db.ref(`full_history/${device.id}`).once('value').then(snapshot => {
      const data = snapshot.val();
      if (data) {
        const keys = Object.keys(data).sort().reverse();
        keys.forEach(key => {
          const item = data[key];
          const historyItem = {
            timestamp: item.timestamp || '-',
            deviceName: device.name,
            status: item.status || '-',
            jarak: item.jarak !== undefined ? item.jarak : '-',
            persentase: item.persentase !== undefined ? item.persentase : '-',
            urgensi: item.urgensi || '-'
          };
          allHistoryData.push(historyItem);

          const row = createHistoryRow(historyItem);
          historyBody.appendChild(row);
          hasData = true;
        });
      }
      
      loading.style.display = 'none';
      table.style.display = hasData ? 'table' : 'none';
      noHistory.style.display = hasData ? 'none' : 'block';
    }).catch(err => {
      console.error("Error:", err);
      loading.textContent = "Gagal memuat riwayat.";
    });
  });
}

function createHistoryRow(item) {
  const row = document.createElement('tr');
  let rowClass = '';
  if (item.status === "KOSONG") rowClass = 'history-row-kosong';
  else if (item.status === "HAMPIR PENUH") rowClass = 'history-row-hampir';
  else if (item.status === "PENUH") rowClass = 'history-row-penuh';

  row.className = rowClass;
  row.innerHTML = `
    <td>${item.timestamp}</td>
    <td><strong>${item.deviceName}</strong></td>
    <td>${item.status}</td>
    <td>${item.jarak}</td>
    <td>${item.persentase !== '-' ? item.persentase + '%' : '-'}</td>
    <td>${item.urgensi}</td>
  `;
  return row;
}

function applyFilters() {
  const startDate = document.getElementById('filterStartDate').value;
  const endDate = document.getElementById('filterEndDate').value;
  const selectedDevice = document.getElementById('filterDevice').value;
  const selectedStatus = document.getElementById('filterStatus').value;

  const historyBody = document.getElementById('historyBody');
  historyBody.innerHTML = '';

  const filteredData = allHistoryData.filter(item => {
    let matches = true;
    if (startDate || endDate) {
      const itemDate = new Date(item.timestamp);
      if (startDate && itemDate < new Date(startDate)) matches = false;
      if (endDate && itemDate > new Date(endDate + 'T23:59:59')) matches = false;
    }
    if (selectedDevice && item.deviceName !== selectedDevice) matches = false;
    if (selectedStatus && item.status !== selectedStatus) matches = false;
    return matches;
  });

  if (filteredData.length === 0) {
    document.getElementById('noHistory').style.display = 'block';
    document.getElementById('historyTable').style.display = 'none';
  } else {
    filteredData.forEach(item => {
      const row = createHistoryRow(item);
      historyBody.appendChild(row);
    });
    document.getElementById('noHistory').style.display = 'none';
    document.getElementById('historyTable').style.display = 'table';
  }
}

function exportToCSV() {
  const rows = [['Waktu', 'Device', 'Status', 'Jarak (cm)', 'Persentase', 'Urgensi']];
  document.querySelectorAll('#historyBody tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    rows.push([
      cells[0].textContent,
      cells[1].textContent,
      cells[2].textContent,
      cells[3].textContent,
      cells[4].textContent,
      cells[5].textContent
    ]);
  });

  let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
  const link = document.createElement("a");
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download", "history_data.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function clearAllData() {
  if (confirm("Apakah Anda yakin ingin menghapus semua data riwayat? Tindakan ini tidak dapat dibatalkan.")) {
    devices.forEach(device => db.ref(`full_history/${device.id}`).remove());
    allHistoryData = [];
    document.getElementById('historyBody').innerHTML = '';
    document.getElementById('historyTable').style.display = 'none';
    document.getElementById('noHistory').style.display = 'block';
    alert("Semua data riwayat telah dihapus.");
  }
}

window.addEventListener('load', () => {
  render();
});
</script>
</body>
</html>
